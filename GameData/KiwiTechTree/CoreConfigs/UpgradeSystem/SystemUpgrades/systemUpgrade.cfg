// Kiwi's Tech Tree Overhaul (Liquid Fuel Tanks Upgrades)
// Version 2.0
// Created: 31 October 2020 for KSP 1.9.1
// Last Updated: 3 January 2021 for KSP 1.11.1
// 2 November 2020: Added text to identify the location of upgrades in tech tree.
// 6 November 2020: Added monopropellant only variant; Liquid Hydrogen/Oxidizer Variant
// 3 January 2021: Applied new system upgrade settings.

@PART[*]:HAS[#kiwiSystemUpgradeType,@RESOURCE[MonoPropellant],@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],~systemUpgrade[off]]:NEEDS[!CryoTanks]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	%monCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	@monCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	
	@liqCost += #$oxiCost$ // Total Costs of Fuel
	@liqCost += #$monCost$
	@liqCost *= -1
	
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_BASELINE_MATERIAL // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = ResourceColorLiquidFuel
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_UPGRADE_MATERIAL // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_PART_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass!
			upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = ResourceColorLiquidFuel
	    }		
	}
}

@PART[*]:HAS[#kiwiSystemUpgradeType,!RESOURCE[MonoPropellant],@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],~systemUpgrade[off]]:NEEDS[!CryoTanks]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	//%monCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	//@monCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	
	@liqCost += #$oxiCost$ // Total Costs of Fuel
	//@liqCost += #$monCost$
	@liqCost *= -1
	
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_COST_MULTIPLIER$
	
		
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_BASELINE_MATERIAL // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = ResourceColorLiquidFuel
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_UPGRADE_MATERIAL // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_PART_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass!
			upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = ResourceColorLiquidFuel
	    }		
	}	
}

@PART[*]:HAS[#kiwiSystemUpgradeType,@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],~systemUpgrade[off]]:NEEDS[CryoTanks]:FOR[zzzKiwiTechTree]
{
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
	{
		@SUBTYPE[*_Composite],*
	    {
			%upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
	    }		
	}	
}

@PART[*]:HAS[#kiwiSystemUpgradeType,@RESOURCE[LqdHydrogen],@RESOURCE[Oxidizer],~systemUpgrade[off]]:NEEDS[CryoTanks]:FOR[zzzKiwiTechTree]
{
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
	{
		@SUBTYPE[*_Composite],*
	    {
			%upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
	    }		
	}	
}

@PART[*]:HAS[#kiwiSystemUpgradeType,!RESOURCE[MonoPropellant],@RESOURCE[LiquidFuel],!RESOURCE[Oxidizer],~systemUpgrade[off]]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	//%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	//@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	//%monCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	//@monCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	
	//@liqCost += #$oxiCost$ // Total Costs of Fuel
	//@liqCost += #$monCost$
	@liqCost *= -1
	
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_BASELINE_MATERIAL // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = ResourceColorLiquidFuel
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_UPGRADE_MATERIAL // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_PART_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass!
			upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = ResourceColorLiquidFuel
	    }		
	}
}

@PART[*]:HAS[#kiwiSystemUpgradeType,@RESOURCE[MonoPropellant],!RESOURCE[LiquidFuel],!RESOURCE[Oxidizer],~systemUpgrade[off]]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = 0
	//@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	//%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	//@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	%monCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	@monCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	
	//@liqCost += #$oxiCost$ // Total Costs of Fuel
	@liqCost += #$monCost$
	@liqCost *= -1
	
	%costAdjust = #$cost$
	//@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_BASELINE_MATERIAL // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = ResourceColorMonoPropellant
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_UPGRADE_MATERIAL // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_PART_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass!
			upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = ResourceColorMonoPropellant
	    }		
	}
}

@PART[*]:HAS[#kiwiSystemUpgradeType,!RESOURCE[MonoPropellant],!RESOURCE[LiquidFuel],!RESOURCE[Oxidizer],~systemUpgrade[off]]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	//%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	//@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	//%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	//@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	//%monCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	//@monCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	
	//@liqCost += #$oxiCost$ // Total Costs of Fuel
	//@liqCost += #$monCost$
	//@liqCost *= -1
	
	%costAdjust = #$cost$
	//@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_SYSTEM_MULTIPLIERS/SYSTEM/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_BASELINE_MATERIAL // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = #ffffff
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_UPGRADE_MATERIAL // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_PART_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass!
			upgradeRequired = #$../../kiwiSystemUpgradeType$Upgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = #ffffff
	    }		
	}
}

PARTUPGRADE:NEEDS[Squad]
{
    type = system
    name = landersUpgrade
    partIcon = landerCabinSmall
    techRequired = advMetalworks
    entryCost = 40000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SYSTEM // INSERTPARTTITLE Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SYSTEM // Decrease in Dry Mass
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSYSTEM!
}
@PARTUPGRADE[landersUpgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:Landers:
    @description ^= :INSERTSYSTEM:Landers:
}
@PART[*]:HAS[#kiwiSystemUpgradeType[landers],~systemUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SYSTEM // The INSERTSYSTEMUPGRADENAME has upgrades in INSERTSYSTEMUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTSYSTEMUPGRADENAME:$@PARTUPGRADE[landersUpgrade]/title$:
    @description ^= :INSERTSYSTEMUPGRADENODE:Advanced MetalWorks (Tier 7):
}
PARTUPGRADE:NEEDS[Squad]
{
    type = system
    name = mark1Upgrade
    partIcon = Mark1Cockpit
    techRequired = advConstruction
    entryCost = 20000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SYSTEM // INSERTPARTTITLE Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SYSTEM // Decrease in Dry Mass
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSYSTEM!
}
@PARTUPGRADE[mark1Upgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:Mark 1 Spaceplane System:
    @description ^= :INSERTSYSTEM:Mark 1 Spaceplane System:
}
@PART[*]:HAS[#kiwiSystemUpgradeType[mark1],~systemUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SYSTEM // The INSERTSYSTEMUPGRADENAME has upgrades in INSERTSYSTEMUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTSYSTEMUPGRADENAME:$@PARTUPGRADE[mark1Upgrade]/title$:
    @description ^= :INSERTSYSTEMUPGRADENODE:Advanced Construction (Tier 5):
}
PARTUPGRADE:NEEDS[Squad]
{
    type = system
    name = mark2Upgrade
    partIcon = mk2Cockpit_Standard
    techRequired = specializedConstruction
    entryCost = 40000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SYSTEM // INSERTPARTTITLE Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SYSTEM // Decrease in Dry Mass
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSYSTEM!
}
@PARTUPGRADE[mark2Upgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:Mark 2 Spaceplane System:
    @description ^= :INSERTSYSTEM:Mark 2 Spaceplane System:
}
@PART[*]:HAS[#kiwiSystemUpgradeType[mark2],~systemUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SYSTEM // The INSERTSYSTEMUPGRADENAME has upgrades in INSERTSYSTEMUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTSYSTEMUPGRADENAME:$@PARTUPGRADE[mark2Upgrade]/title$:
    @description ^= :INSERTSYSTEMUPGRADENODE:Specialized Construction (Tier 6):
}
PARTUPGRADE:NEEDS[Squad]
{
    type = system
    name = mark3Upgrade
    partIcon = mk3Cockpit_Shuttle
    techRequired = nanolathing
    entryCost = 80000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SYSTEM // INSERTPARTTITLE Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SYSTEM // Decrease in Dry Mass
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSYSTEM!
}
@PARTUPGRADE[mark3Upgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:Mark 3 Spaceplane System:
    @description ^= :INSERTSYSTEM:Mark 3 Spaceplane System:
}
@PART[*]:HAS[#kiwiSystemUpgradeType[mark3],~systemUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SYSTEM // The INSERTSYSTEMUPGRADENAME has upgrades in INSERTSYSTEMUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTSYSTEMUPGRADENAME:$@PARTUPGRADE[mark3Upgrade]/title$:
    @description ^= :INSERTSYSTEMUPGRADENODE:Nanolathing (Tier 8):
}
PARTUPGRADE:NEEDS[Squad]
{
    type = system
    name = spaceCapsulesUpgrade
    partIcon = mk1-3pod
    techRequired = nanolathing
    entryCost = 50000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SYSTEM // INSERTPARTTITLE Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SYSTEM // Decrease in Dry Mass
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SYSTEM // The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSYSTEM!
}
@PARTUPGRADE[spaceCapsulesUpgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:Mk 1-3 Space Capsules:
    @description ^= :INSERTSYSTEM:Mk 1-3 Space Capsules:
}
@PART[*]:HAS[#kiwiSystemUpgradeType[spaceCapsules],~systemUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SYSTEM // The INSERTSYSTEMUPGRADENAME has upgrades in INSERTSYSTEMUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTSYSTEMUPGRADENAME:$@PARTUPGRADE[spaceCapsulesUpgrade]/title$:
    @description ^= :INSERTSYSTEMUPGRADENODE:Nanolathing (Tier 8):
}
