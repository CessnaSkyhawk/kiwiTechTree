// Kiwi's Tech Tree Overhaul (Liquid Fuel Tanks Upgrades)
// Version 2.0
// Created: 31 October 2020 for KSP 1.9.1 to 1.10.1
// Last Updated: 3 January 2021
// 2 November 2020: Added text to identify the location of an upgrade, $@PARTUPGRADE[]/title$, found intech tree.
// 10 November 2020: Added support for fuel tanks larger than 10 meters (ie. Nexus)
// 23 November 2020: Added support to disable fuel tank upgrades
// 3 January 2021: Updated for new upgrade system.

@PART[*]:HAS[#kiwiTankUpgradeType[fuel],@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],~fuelTankUpgrade[off]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_FUELTANK_MULTIPLIERS/LIQUIDFUEL/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	
	%oxiCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@oxiCost *= #$RESOURCE[Oxidizer]/maxAmount$
	
	@liqCost += #$oxiCost$ // Total Costs of Fuel
	@liqCost *= -1
	
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$
	@costAdjust *= #$@KIWI_FUELTANK_MULTIPLIERS/LIQUIDFUEL/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_BASELINE // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = ResourceColorLiquidFuel
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_UPGRADE // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_B9DESCRIPTION_FUELMATERIALSWITCH_UPGRADE // The imagineers have introduced composite materials that have reduced the dry mass of the fuel tank.
			upgradeRequired = #$../../kiwiTankSize$FuelUpgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = ResourceColorLiquidFuel
	    }		
	}	
}

@PART[*]:HAS[#kiwiTankUpgradeType[fuel],~fuelTankUpgrade[off]]:NEEDS[CryoTanks]:FOR[zzzKiwiTechTree]
{	
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
	{
		@SUBTYPE[*_Composite],*
	    {
			%upgradeRequired = #$../../kiwiTankSize$FuelUpgrade
	    }		
	}	
}
