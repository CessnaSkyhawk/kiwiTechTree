// Kiwi's Tech Tree Overhaul (SRB Tank Upgrades)
// Version 2.0
// Created: 24 October 2020 for KSP 1.9.1 to 1.10.1
// Last Updated: 3 January 2021 for KSP 1.11.1
// 29 October 2020: Incorrect NEEDS on the SRB PARTUPGRADE
// 1 November 2020: Added general upgrade configuration
// 23 November 2020: Added support to disable fuel tank upgrades
// 3 January 2021: Updated for new upgrade system.

@PART[*]:HAS[#category[Engine],@RESOURCE[SolidFuel],~fuelTankUpgrade[off]]:AFTER[zzKiwiTechTree]
{
	%descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_SRB // This SRB has an upgrade, INSERTTITLE, found in INSERTPARTUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTTITLE:$@PARTUPGRADE[srbFuelUpgrade]/title$:
    @description ^= :INSERTPARTUPGRADENODE:Larger Solid Rocket Boosters (Tier 7):
	
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_FUELTANK_MULTIPLIERS/SOLIDROCKETBOOSTER/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[SolidFuel]/unitCost$
	@liqCost *= #$RESOURCE[SolidFuel]/maxAmount$
	@liqCost *= -1
	
	// Long Equations
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$ // Subtract fuel
	@costAdjust *= #$@KIWI_FUELTANK_MULTIPLIERS/SOLIDROCKETBOOSTER/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_BASELINE // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = BrownyOrange
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_UPGRADE // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_B9DESCRIPTION_FUELMATERIALSWITCH_UPGRADE // The imagineers have introduced composite materials that have reduced the dry mass of the fuel tank.
			upgradeRequired = srbFuelUpgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = BrownyOrange
	    }		
	}
}

@PART[*]:HAS[#category[Propulsion],@RESOURCE[SolidFuel],~fuelTankUpgrade[off]]:AFTER[zzKiwiTechTree] // Catch some of the Knes SRBs
{
	%descriptionUpgrade = #LOC_KTT_PART_DESCRIPTIONUPGRADE_FUELTANKS // This fuel tank has an upgrade, INSERTTITLE, found in INSERTPARTUPGRADENODE!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= #:INSERTTITLE:$@PARTUPGRADE[srbFuelUpgrade]/title$:
    @description ^= :INSERTPARTUPGRADENODE:Larger Solid Rocket Boosters (Tier 7):
	
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= #$@KIWI_FUELTANK_MULTIPLIERS/SOLIDROCKETBOOSTER/UPGRADE_MASS_MULTIPLIER$
	@dryMass *= -1
	
	// Long Equations
	%liqCost = #$@RESOURCE_DEFINITION[SolidFuel]/unitCost$
	@liqCost *= #$RESOURCE[SolidFuel]/maxAmount$
	@liqCost *= -1
	
	// Long Equations
	%costAdjust = #$cost$
	@costAdjust += #$liqCost$ // Subtract fuel
	@costAdjust *= #$@KIWI_FUELTANK_MULTIPLIERS/SOLIDROCKETBOOSTER/UPGRADE_COST_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = materialSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_MATERIALSWITCH // Material Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_MATERIALTYPES // Material Types
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = Baseline
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_BASELINE // Baseline Material
			descriptionSummary = 
			descriptionDetail =
			addedCost = 0
			defaultSubtypePriority = 1
			primaryColor = #fb8e8e
			secondaryColor = BrownyOrange
	    }
		
		SUBTYPE
	    {
			name = Improved
			title = #LOC_KTT_B9TITLE_FUELMATERIALSWITCH_UPGRADE // Composite Material
			descriptionSummary = 
			descriptionDetail = #LOC_KTT_B9DESCRIPTION_FUELMATERIALSWITCH_UPGRADE // The imagineers have introduced composite materials that have reduced the dry mass of the fuel tank.
			upgradeRequired = srbFuelUpgrade
			addedCost = #$../../costAdjust$
			addedMass = #$../../dryMass$
			defaultSubtypePriority = 0
			primaryColor = #c74c4c
			secondaryColor = BrownyOrange
	    }		
	}
}

PARTUPGRADE:NEEDS[Squad]
{
    type = fuelTank
    name = srbFuelUpgrade
    partIcon = solidBooster_v2
    techRequired = largerBoosters
    entryCost = 150000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_FUELTANKS // INSERTPARTTITLE Fuel Tank Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_FUELTANKS // Decrease in Dry Mass of Fuel Tanks
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_FUELTANKS = The imagineers have introduced composite materials that have reduced the dry mass of the INSERTSIZE fuel tanks.
}
@PARTUPGRADE[srbFuelUpgrade]:NEEDS[Squad]
{
    @title ^= :INSERTPARTTITLE:SRB:
    @description ^= :INSERTSIZE:SRB:
}
